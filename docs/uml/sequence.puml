@startuml
title Sequence — Intake & Receipt
autonumber
actor "Житель" as U
participant "POS" as POS
participant "Весы" as S
participant "API" as API
participant "Core" as CORE
participant "Принтер" as FP

U -> POS: старт сессии (язык/согласие)
U -> POS: взвесить тару / без-тары
POS -> S: read(tare?)
S --> POS: tareWeight
U -> POS: снять брутто
POS -> S: read(gross)
S --> POS: grossWeight
POS -> POS: net = gross - tare
POS -> API: GET /tariffs?fraction=...
API -> CORE: tariffs()
CORE --> API: {coeff, price}
API --> POS: 200 {tariffs}
POS -> POS: calc amount/points
alt некорректный вес
  POS -> U: сообщение + возврат
  return
end
POS -> U: показать сумму/баллы
U --> POS: подтвердить
POS -> API: POST /batches {net,fraction}
API -> CORE: createBatch()
CORE --> API: 201 {batchId}
API --> POS: 201 {batchId}
POS -> FP: print(receipt)
alt ошибка печати
  FP --> POS: error
  POS -> U: эл.чек / повтор
else ok
  FP --> POS: ok
end
POS -> POS: закрыть сессию
@enduml
