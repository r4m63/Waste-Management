@startuml
title UC3: Переработка, склад и утилизация остатков
skinparam defaultFontName "DejaVu Sans"
autonumber

actor "Кладовщик" as W
actor "Оператор переработки" as P
actor "Технолог" as T
actor "Эколог" as E
actor "Подрядчик" as C
participant "ИС" as IS
participant "Весы" as S

== 1. Передача фракций в переработку ==
W -> IS: Создать задание на перемещение
IS --> W: moveOrderId
W -> IS: Автоподбор кип по приоритету? (опция)
IS --> W: Список кип
W -> IS: Скан ярлыков при отборе
W -> IS: Приёмка на складе переработки (скан)
alt Несовпадение ярлыка
  IS --> W: Отказ приёмки, вернуть на отбор
  return
end
IS -> IS: Фиксация передачи, списание с исходного места

== 2. Запуск техпроцесса ==
P -> IS: Создать заказ на переработку
IS --> P: orderId
P -> IS: Ввод параметров (время, t°, режимы)
alt Не все параметры заданы
  IS --> P: Подсказка + запрет запуска
  return
end
P -> IS: Старт заказа
IS -> IS: Мониторинг/контроль параметров

== 3. Учёт выхода и побочных ==
P -> S: Взвесить готовый продукт
S --> P: mass_product
alt Нестабильные показания
  P -> S: Повторить
  S --> P: mass_product'
end
P -> S: Взвесить побочные
S --> P: mass_byprod
alt Нет данных сейчас
  P -> IS: Пометка "ожидает ввода"
else Есть данные
  P -> IS: Запись фактов (product/byprod)
end
IS -> IS: Обновить свод заказа

== 4. Приём на склад готового сырья ==
W -> IS: Присвоить артикул (SKU) и ярлык
alt Артикула нет
  IS --> W: Создать новый SKU
end
W -> IS: Выбор места хранения
alt Нет свободных мест
  IS --> W: Альтернатива/буфер
end
IS -> IS: Создать карточку качества/объёма, зафиксировать размещение

== 5. Планирование утилизации остатков ==
E -> IS: Выбор подрядчика, проверка лицензии
alt Лицензия недействительна
  IS --> E: Предложить другого
  return
end
E -> IS: Создать заявку на утилизацию
W -> IS: Погрузка, скан позиций
alt Частичная отгрузка
  IS --> W: Корректировка заявки
end
IS -> IS: Сопроводительные документы
C -> IS: Электронное подтверждение получения
alt Не подтвердил
  IS --> E: Зафиксировать отказ + уведомление
else Подтвердил
  IS --> E: OK
end
IS -> IS: Регистрация акта утилизации

== 6. Закрытие смены ==
T -> IS: Команда "Закрыть смену"
alt Есть незаполненные данные
  IS --> T: Список для исправления
  T -> IS: Исправления
end
IS -> IS: Расчёт KPI/выхода; формирование отчётов (регуляторные/ESG)
IS --> T: Смена в статусе "Закрыта"
@enduml
