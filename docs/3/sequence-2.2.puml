@startuml
title UC2: Сортировка и оформление результатов
skinparam defaultFontName "DejaVu Sans"
autonumber

actor "Технолог" as T
actor "Оператор линии" as O
participant "ИС" as IS
participant "Весы" as S

== Открытие смены ==
T -> IS: Ввод норм по фракциям/качеству
alt Не все поля заполнены
  IS --> T: Подсветить обязательные
  T -> IS: Дозаполнить
end
T -> IS: Открыть смену
IS --> T: shiftId

== Подача партии на линию ==
O -> IS: Скан ярлыка партии
IS -> IS: Проверка пригодности
alt Партия не подходит
  IS --> O: Отказ + причина
  return
end
IS -> IS: Статус партии = "На сортировке"

== Формирование кип ==
loop На каждую кипу
  O -> IS: Выбор фракции
  O -> S: Взвесить кипу
  S --> O: mass
  alt Нестабильные показания
    O -> S: Повторить
    S --> O: mass'
  end
  O -> IS: Запись массы + присвоение ярлыка
  IS -> IS: Обновление выпуска по фракции
end

== Классификация качества ==
O -> IS: Оценка чистоты/влажности
alt Нет возможности оценить
  IS --> O: Статус "ожидает оценки"
else Оценено
  O -> IS: Выбор класса A/B/C
end

== Учёт хвостов ==
O -> S: Взвесить хвосты
S --> O: tails_mass
alt Нет точного веса
  O -> IS: Ввод оценочного значения (+метка)
else Есть точный вес
  O -> IS: tails_mass
end
IS -> IS: Обновление баланса

== Акт сортировки ==
IS -> IS: Формирование свода (вход/выпуск/хвосты)
alt Баланс не сходится
  IS --> O: Подсветить расхождения
  O -> IS: Исправления
end
IS --> T: Draft акта
T -> IS: Утвердить акт
alt Возврат на доработку
  IS --> T: Акт не утверждён (причины)
  T -> IS: Комментарии/правки
else Утверждён
  IS --> T: Акт утверждён
end
@enduml
